<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nevar • Painel Demo</title>
<meta name="description" content="Painel demo da Nevar: O.S., Orçamentos, Estoque, Financeiro, Relatórios, CMS/Leads e Usuários.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: { extend: {
    fontFamily:{ sans:['Inter','ui-sans-serif','system-ui'] },
    colors:{
      base:'#0b0f14', card:'#11161c', edge:'rgba(255,255,255,.06)',
      ink:'rgba(255,255,255,.88)', mute:'rgba(255,255,255,.58)',
      brand:{500:'#00c2ff',600:'#00a9e0'}, ok:'#34d399', warn:'#f59e0b', danger:'#ef4444'
    },
    boxShadow:{ glow:'0 14px 48px rgba(0,194,255,.28)' }
  } }
}
</script>
<style>
html,body{ background:#0b0f14; color:var(--ink,rgba(255,255,255,.92)); }
.card{ background:#11161c; border:1px solid rgba(255,255,255,.06); border-radius:16px }
.soft{ background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.05); border-radius:14px }
.btn{ display:inline-flex; align-items:center; justify-content:center; padding:.85rem 1rem; border-radius:12px; font-weight:700; }
.btn-primary{ background:#00c2ff; color:#001219; }
.btn-primary:hover{ background:#00a9e0; box-shadow:0 12px 36px rgba(0,194,255,.28) }
.btn-ghost{ border:1px solid rgba(255,255,255,.12) }
.badge{ padding:.22rem .6rem; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:.72rem }
.hiddenEl{ display:none }
.tab-active{ color:#00c2ff }

/* Barra inferior fixa */
.sticky-bottom{
  position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom);
  z-index:30; /* menor que modal */
  border-top:1px solid rgba(255,255,255,.08); background:rgba(11,15,20,.92); backdrop-filter:blur(10px)
}
.pad-tabbar{ padding-bottom:calc(84px + env(safe-area-inset-bottom)); }
.tabm{ opacity:.85; transition:.15s } .tabm.tab-active{ color:#00c2ff; opacity:1 }

/* listas em cards */
.kpi{ display:flex; flex-direction:column; gap:.25rem } .kpi .v{ font-size:1.6rem; font-weight:800 }
.list-card{ border-radius:14px; border:1px solid rgba(255,255,255,.08); background:#0f141a; padding:.9rem }

/* modal: em cima de tudo */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:flex-end;
  z-index:9999; /* acima de qualquer coisa */
}
@media (min-width:768px){ .modal-backdrop{ align-items:center; justify-content:center } }
.modal{ width:100%; max-width:760px; background:#11161c; border:1px solid rgba(255,255,255,.08); border-radius:16px 16px 0 0; }
@media (min-width:768px){ .modal{ border-radius:16px } }
.modal-h{ padding:1rem 1.25rem; border-bottom:1px solid rgba(255,255,255,.08) }
.modal-b{ padding:1rem 1.25rem; max-height:70vh; overflow:auto }
.modal-f{ padding:1rem 1.25rem; border-top:1px solid rgba(255,255,255,.08) }

/* assinatura */
.sig-pad{ background:#0e1318; border:1px dashed rgba(255,255,255,.12); border-radius:12px }

/* FAB */
.fab{
  position:fixed; right:16px; bottom:calc(100px + env(safe-area-inset-bottom));
  background:#00c2ff; color:#001219; width:56px; height:56px; border-radius:16px;
  display:grid; place-items:center; font-size:28px; box-shadow:0 16px 40px rgba(0,194,255,.35); z-index:40;
}
.fab:active{ transform: translateY(1px) }

/* esconder UI ao abrir modal */
.ui-hide{ opacity:0; transform:translateY(120%); pointer-events:none; transition:.2s }

/* grid desktop */
@media (min-width:1024px){ .container-grid{ grid-template-columns: 240px 1fr } }

/* evita scroll da página quando modal estiver aberto */
body.lock{ overflow:hidden }
</style>
</head>
<body class="font-sans">

<header class="sticky top-0 z-40 border-b border-edge/50 bg-base/80 backdrop-blur">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-brand-500 grid place-items-center font-extrabold text-[#03131a]">NV</div>
      <div class="font-extrabold tracking-wide">Nevar</div>
      <span class="hidden sm:inline text-mute text-sm">• Painel Demo</span>
    </div>
    <div class="flex items-center gap-2">
      <a class="hidden sm:inline-flex btn btn-ghost" href="/site.html" target="_blank">Ver Site</a>
      <button id="btnLogout" class="btn btn-ghost">Sair</button>
    </div>
  </div>
</header>

<!-- AUTH -->
<section id="authSection" class="max-w-md mx-auto p-4">
  <div id="firstAccess" class="card p-6 mt-6">
    <h1 class="text-2xl font-extrabold">Primeiro Acesso — Nevar</h1>
    <p class="text-mute mt-1">Crie o Administrador para começar</p>
    <form id="firstForm" class="mt-4 grid gap-3">
      <input class="px-4 py-3 soft" placeholder="Nome" required>
      <input class="px-4 py-3 soft" placeholder="E-mail" type="email" required>
      <input class="px-4 py-3 soft" placeholder="Senha" type="password" required>
      <button class="btn btn-primary">Criar Administrador</button>
    </form>
  </div>

  <div id="loginBox" class="card p-6 mt-4">
    <h2 class="text-xl font-bold">Entrar</h2>
    <form id="loginForm" class="mt-3 grid gap-3">
      <input id="loginEmail" class="px-4 py-3 soft" placeholder="E-mail" type="email" required>
      <input id="loginPass"  class="px-4 py-3 soft" placeholder="Senha" type="password" required>
      <button class="btn btn-primary">Acessar</button>
    </form>
  </div>
</section>

<!-- APP -->
<main id="app" class="hiddenEl pad-tabbar">
  <section class="max-w-6xl mx-auto px-4 py-4">
    <div class="card p-4 mb-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="badge">NEVAR • ADMIN</div>
          <h1 class="text-2xl font-extrabold mt-2">Painel • Visão Geral</h1>
          <p class="text-mute text-sm">Gerencie O.S., orçamentos, estoque e finanças.</p>
        </div>
        <a class="hidden sm:inline-flex btn btn-primary" href="https://wa.me/5511999999999?text=Olá%20Nevar!%20Quero%20entender%20o%20sistema.">WhatsApp</a>
      </div>
    </div>

    <div class="grid gap-4 lg:container-grid">
      <aside class="hidden lg:block card p-3 h-fit">
        <nav id="menu" class="grid gap-1 text-sm">
          <button data-tab="dashboard"  class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">Dashboard</button>
          <button data-tab="os"         class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">O.S.</button>
          <button data-tab="orcamentos" class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">Orçamentos</button>
          <button data-tab="estoque"    class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">Estoque</button>
          <button data-tab="financeiro" class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">Financeiro</button>
          <button data-tab="relatorios" class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">Relatórios</button>
          <button data-tab="cms"        class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">CMS / Leads</button>
          <button data-tab="usuarios"   class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">Usuários</button>
          <button data-tab="tecnicos"   class="tab px-3 py-2 rounded-lg text-left hover:bg-white/5">Técnicos</button>
        </nav>
      </aside>

      <section class="grid gap-4">

        <div id="tab-dashboard" class="card p-4">
          <h2 class="text-lg font-bold">Resumo</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
            <div class="soft p-4 kpi"><span class="text-mute text-xs">O.S. Abertas</span><span id="kOsAbertas" class="v">0</span></div>
            <div class="soft p-4 kpi"><span class="text-mute text-xs">Em Andamento</span><span id="kOsAnd" class="v">0</span></div>
            <div class="soft p-4 kpi"><span class="text-mute text-xs">Orç. Pendentes</span><span id="kOrcPend" class="v">0</span></div>
            <div class="soft p-4 kpi"><span class="text-mute text-xs">Faturamento</span><span id="kFatMes" class="v">R$ 0</span></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="soft p-4 md:col-span-2">
              <div class="flex items-center justify-between">
                <h3 class="font-bold">O.S. — Kanban</h3>
                <button id="btnNovaOS" class="btn btn-primary">Nova O.S.</button>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
                <div class="list-card">
                  <div class="flex items-center justify-between"><b>Abertas</b><span class="badge" id="cA">0</span></div>
                  <div id="kanbanA" class="mt-2 space-y-2"></div>
                </div>
                <div class="list-card">
                  <div class="flex items-center justify-between"><b>Em andamento</b><span class="badge" id="cE">0</span></div>
                  <div id="kanbanE" class="mt-2 space-y-2"></div>
                </div>
                <div class="list-card">
                  <div class="flex items-center justify-between"><b>Concluídas</b><span class="badge" id="cC">0</span></div>
                  <div id="kanbanC" class="mt-2 space-y-2"></div>
                </div>
              </div>
            </div>
            <div class="soft p-4">
              <h3 class="font-bold">Fluxo de Caixa (demo)</h3>
              <canvas id="chart" class="w-full h-[180px]"></canvas>
              <div class="text-xs text-mute mt-2">Gráfico ilustrativo.</div>
            </div>
          </div>
        </div>

        <div id="tab-os" class="card p-4 hiddenEl">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold">Ordens de Serviço</h2>
            <button id="btnNovaOS2" class="btn btn-primary">Nova O.S.</button>
          </div>
          <div id="osList" class="mt-3 grid gap-2"></div>
        </div>

        <div id="tab-orcamentos" class="card p-4 hiddenEl">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold">Orçamentos</h2>
            <div class="flex gap-2">
              <button id="btnNovoOrc" class="btn btn-primary">Novo Orçamento</button>
            </div>
          </div>
          <div id="orcList" class="mt-3 grid gap-2"></div>
        </div>

        <div id="tab-estoque" class="card p-4 hiddenEl">
          <h2 class="text-lg font-bold">Estoque</h2>
          <div id="stkList" class="mt-3 grid gap-2"></div>
        </div>

        <div id="tab-financeiro" class="card p-4 hiddenEl">
          <h2 class="text-lg font-bold">Financeiro</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3">
            <div class="soft p-4 kpi"><span class="text-mute text-xs">A Receber</span><span id="fatRec" class="v">R$ 0</span></div>
            <div class="soft p-4 kpi"><span class="text-mute text-xs">A Pagar</span><span id="fatPag" class="v">R$ 0</span></div>
            <div class="soft p-4 kpi md:col-span-1 col-span-2"><span class="text-mute text-xs">Saldo</span><span id="fatSaldo" class="v">R$ 0</span></div>
          </div>
          <div id="finList" class="mt-3 grid gap-2"></div>
        </div>

        <div id="tab-relatorios" class="card p-4 hiddenEl">
          <h2 class="text-lg font-bold">Relatórios</h2>
          <ul class="mt-3 grid gap-2">
            <li class="list-card">📄 O.S. por status (mensal)</li>
            <li class="list-card">📄 Faturamento por serviço</li>
            <li class="list-card">📄 Consumo de peças por técnico</li>
          </ul>
        </div>

        <div id="tab-cms" class="card p-4 hiddenEl">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold">Leads do Site</h2>
            <a class="btn btn-ghost" href="/site.html" target="_blank">Abrir site</a>
          </div>
          <p class="text-mute text-sm">Leads salvos em <code>localStorage.nevar_leads</code>.</p>
          <div id="leadList" class="mt-3 grid gap-2"></div>
        </div>

        <div id="tab-usuarios" class="card p-4 hiddenEl">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold">Usuários</h2>
            <button id="btnAddUser" class="btn btn-primary">Novo Usuário</button>
          </div>
          <div id="usrList" class="mt-3 grid gap-2"></div>
        </div>

        <div id="tab-tecnicos" class="card p-4 hiddenEl">
          <h2 class="text-lg font-bold">Tarefas do Técnico</h2>
          <div id="tecList" class="mt-3 grid gap-2"></div>
        </div>
      </section>
    </div>
  </section>

  <button id="fab" class="fab" title="Nova O.S.">＋</button>

  <nav id="bottomBar" class="lg:hidden sticky-bottom">
    <div class="max-w-6xl mx-auto grid grid-cols-5 text-xs px-2" style="padding-bottom: env(safe-area-inset-bottom);">
      <button data-tab="dashboard"  class="m-1 py-3 text-center tabm">🏠<div>Home</div></button>
      <button data-tab="os"         class="m-1 py-3 text-center tabm">🧾<div>O.S.</div></button>
      <button data-tab="orcamentos" class="m-1 py-3 text-center tabm">💬<div>Orç.</div></button>
      <button data-tab="financeiro" class="m-1 py-3 text-center tabm">💼<div>Fin.</div></button>
      <button data-tab="cms"        class="m-1 py-3 text-center tabm">📣<div>Leads</div></button>
    </div>
  </nav>
</main>

<!-- MODAL O.S. -->
<div id="osModalWrap" class="modal-backdrop hiddenEl" aria-hidden="true">
  <div class="modal w-full">
    <div class="modal-h flex items-center justify-between">
      <div class="font-bold" id="osModalTitle">O.S.</div>
      <button id="osModalClose" class="btn btn-ghost">Fechar</button>
    </div>
    <div class="modal-b grid gap-3" id="osModalBody"></div>
    <div class="modal-f flex items-center justify-between">
      <button id="btnDelOS" class="btn btn-ghost">Excluir</button>
      <div class="flex gap-2">
        <button id="btnExportOS" class="btn btn-ghost">Exportar PDF</button>
        <button id="btnSaveOS" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const get = k => JSON.parse(localStorage.getItem(k)||'[]');
const set = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const money = v => 'R$ ' + (v).toLocaleString('pt-BR', {minimumFractionDigits:2});
const show = id => $('#'+id).classList.remove('hiddenEl');
const hide = id => $('#'+id).classList.add('hiddenEl');

/* ===== seed ===== */
(function seed(){
  if(!localStorage.getItem('demo_seed_v3')){
    set('nevar_os', [
      {id:'OS-101', cliente:'Restaurante Aurora', servico:'Câmara fria', status:'aberta', valor:3200, obs:'', fotos:[], ass:''},
      {id:'OS-102', cliente:'Clínica Vita', servico:'VRF', status:'andamento', valor:12800, obs:'', fotos:[], ass:''},
      {id:'OS-103', cliente:'Supermercado Max', servico:'Split', status:'andamento', valor:1800, obs:'', fotos:[], ass:''},
      {id:'OS-104', cliente:'Hotel Blue', servico:'Preventiva', status:'concluida', valor:950, obs:'', fotos:[], ass:''}
    ]);
    set('nevar_orc', [
      {id:'ORC-7001', cliente:'Rest. Flor do Mar', item:'Split 24k + Instalação', status:'pendente', valor:4900, notas:''},
      {id:'ORC-7002', cliente:'TechLab', item:'VRF 20TR', status:'enviado', valor:86000, notas:''}
    ]);
    set('nevar_stock', [
      {sku:'PE-001', nome:'Gás R410A', qtd:12, minimo:5},
      {sku:'PE-002', nome:'Filtro Secador', qtd:30, minimo:10},
      {sku:'PE-003', nome:'Válvula de Expansão', qtd:8, minimo:5}
    ]);
    set('nevar_fin', [
      {id:'F-01', tipo:'receber', desc:'OS-102 • VRF', valor:12800},
      {id:'F-02', tipo:'receber', desc:'OS-103 • Split', valor:1800},
      {id:'F-03', tipo:'pagar',   desc:'Compra de peças', valor:3500}
    ]);
    set('nevar_users', [{nome:'Admin', email:'admin@nevar.com', perfil:'Administrador'}]);
    set('nevar_tec', [
      {tec:'Carlos', os:'OS-103', tarefa:'Instalar condensadora', status:'pendente'},
      {tec:'Fernanda', os:'OS-101', tarefa:'Ajuste termostato', status:'em execução'}
    ]);
    localStorage.setItem('demo_seed_v3','1');
  }
})();

/* ===== auth ===== */
const hasAdmin = () => !!localStorage.getItem('nevar_admin');
const setSession = v => localStorage.setItem('nevar_session', v?'1':'');
const isLogged = () => !!localStorage.getItem('nevar_session');

function renderAuth(){ if(!hasAdmin()) show('firstAccess'); else hide('firstAccess'); }
renderAuth();

$('#firstForm').addEventListener('submit', e=>{
  e.preventDefault();
  const [nome,email,senha] = [...e.target.querySelectorAll('input')].map(i=>i.value.trim());
  localStorage.setItem('nevar_admin', JSON.stringify({nome,email,senha}));
  alert('Administrador criado! Faça login.');
  renderAuth();
});
$('#loginForm').addEventListener('submit', e=>{
  e.preventDefault();
  const admin = JSON.parse(localStorage.getItem('nevar_admin')||'{}');
  if($('#loginEmail').value.trim()===admin.email && $('#loginPass').value.trim()===admin.senha){
    setSession(true); hide('authSection'); show('app'); selectTab('dashboard'); refreshAll(); ensureModalClosed();
  } else alert('Credenciais inválidas');
});
$('#btnLogout').addEventListener('click', ()=>{ localStorage.removeItem('nevar_session'); show('authSection'); hide('app'); });

/* ===== navegação ===== */
function selectTab(name){
  $$('#menu .tab').forEach(b=>b.classList.remove('bg-white/5','tab-active'));
  $$('#menu .tab').find(b=>b.dataset.tab===name)?.classList.add('bg-white/5','tab-active');
  $$('.tabm').forEach(b=>b.classList.remove('tab-active'));
  $$('.tabm').find(b=>b.dataset.tab===name)?.classList.add('tab-active');
  ['dashboard','os','orcamentos','estoque','financeiro','relatorios','cms','usuarios','tecnicos']
    .forEach(id => (id===name?show('tab-'+id):hide('tab-'+id)));
}
$('#menu')?.addEventListener('click', e=>{
  const b = e.target.closest('.tab'); if(!b) return;
  selectTab(b.dataset.tab); refreshAll(); ensureModalClosed();
});
document.querySelector('nav.sticky-bottom').addEventListener('click', e=>{
  const b = e.target.closest('.tabm'); if(!b) return;
  selectTab(b.dataset.tab); refreshAll(); ensureModalClosed();
});

/* ===== render ===== */
const cardLine = (left, right) => `<div class="flex items-center justify-between gap-3"><span class="text-mute text-sm">${left}</span><span class="font-semibold">${right}</span></div>`;

function renderKPIs(){
  const os = get('nevar_os'), orc = get('nevar_orc'), fin = get('nevar_fin');
  $('#kOsAbertas').textContent = os.filter(i=>i.status==='aberta').length;
  $('#kOsAnd').textContent    = os.filter(i=>i.status==='andamento').length;
  $('#kOrcPend').textContent  = orc.filter(i=>i.status==='pendente').length;
  const saldo = fin.reduce((a,i)=>a + (i.tipo==='receber'?i.valor:-i.valor), 0);
  $('#kFatMes').textContent = money(saldo);
}
function renderKanban(){
  const os = get('nevar_os');
  const col = (status) => os.filter(i => status==='aberta'? i.status==='aberta' : status==='and'? i.status==='andamento' : i.status==='concluida');
  const item = o => `<div class="soft p-3 rounded-xl">
    <div class="font-semibold">${o.id}</div>
    <div class="text-mute text-sm">${o.cliente}</div>
    <div class="badge mt-2">${o.servico}</div>
  </div>`;
  $('#kanbanA').innerHTML = col('aberta').map(item).join(''); $('#cA').textContent = col('aberta').length;
  $('#kanbanE').innerHTML = col('and').map(item).join('');    $('#cE').textContent = col('and').length;
  $('#kanbanC').innerHTML = col('concluida').map(item).join(''); $('#cC').textContent = col('concluida').length;
}
function listify(arr, fields, clickable){
  return arr.map(r => `<button class="list-card text-left" ${clickable? `data-id="${r.id}"` : ''}>
    ${fields.map(f => cardLine(f.label, f.fmt? f.fmt(r[f.key], r): (r[f.key]??''))).join('')}
  </button>`).join('');
}
function renderOS(){ 
  const os = get('nevar_os');
  $('#osList').innerHTML = listify(os, [
    {key:'id',label:'Código'},{key:'cliente',label:'Cliente'},{key:'servico',label:'Serviço'},
    {key:'status',label:'Status'},{key:'valor',label:'Valor', fmt:v=>money(v)} ], true);
  $$('#osList .list-card').forEach(btn => btn.addEventListener('click', ()=> openOSModal(btn.dataset.id)));
}
function renderOrc(){ 
  const o = get('nevar_orc');
  $('#orcList').innerHTML = listify(o, [
    {key:'id',label:'Código'},{key:'cliente',label:'Cliente'},{key:'item',label:'Item'},
    {key:'status',label:'Status'},{key:'valor',label:'Valor', fmt:v=>money(v)} ]);
}
function renderStock(){ $('#stkList').innerHTML = listify(get('nevar_stock'), [
  {key:'sku',label:'SKU'},{key:'nome',label:'Produto'},{key:'qtd',label:'Qtd.'},{key:'minimo',label:'Mín.'} ]); }
function renderFin(){
  const fin = get('nevar_fin');
  const rec = fin.filter(f=>f.tipo==='receber').reduce((a,i)=>a+i.valor,0);
  const pag = fin.filter(f=>f.tipo==='pagar').reduce((a,i)=>a+i.valor,0);
  $('#fatRec').textContent = money(rec); $('#fatPag').textContent = money(pag); $('#fatSaldo').textContent = money(rec-pag);
  $('#finList').innerHTML = listify(fin, [
    {key:'id',label:'ID'},{key:'tipo',label:'Tipo'},{key:'desc',label:'Descrição'},{key:'valor',label:'Valor', fmt:v=>money(v)} ]);
}
function renderLeads(){
  const leads = get('nevar_leads').slice().reverse();
  $('#leadList').innerHTML = leads.length ? listify(leads, [
    {key:'data',label:'Data', fmt:v=>new Date(v).toLocaleString('pt-BR')},
    {key:'servico',label:'Serviço'},{key:'nome',label:'Nome'},{key:'contato',label:'Contato'},{key:'mensagem',label:'Mensagem'} ])
    : '<div class="text-mute">Sem leads ainda. Envie pelo site.</div>';
}
function renderUsers(){ $('#usrList').innerHTML = listify(get('nevar_users'), [
  {key:'nome',label:'Nome'},{key:'email',label:'E-mail'},{key:'perfil',label:'Perfil'} ]); }
function renderTec(){ $('#tecList').innerHTML = listify(get('nevar_tec'), [
  {key:'tec',label:'Técnico'},{key:'os',label:'O.S.'},{key:'tarefa',label:'Tarefa'},{key:'status',label:'Status'} ]); }

function refreshAll(){ renderKPIs(); renderKanban(); renderOS(); renderOrc(); renderStock(); renderFin(); renderLeads(); renderUsers(); renderTec(); drawChart(); }

/* ===== gráfico simples responsivo ===== */
function drawChart(){
  const c = document.getElementById('chart'), ctx = c.getContext('2d');
  const w = c.clientWidth, h = c.clientHeight; c.width=w; c.height=h;
  ctx.clearRect(0,0,w,h);
  const data = [8,12,10,16,14,20], max = Math.max(...data), pad=20, gap=8;
  const bw = (w - pad*2 - gap*(data.length-1)) / data.length;
  ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  data.forEach((v,i)=>{ const x=pad + i*(bw+gap); const bh=(h-pad*2)*(v/max); ctx.fillStyle= i===data.length-1?'#00c2ff':'rgba(255,255,255,.5)'; ctx.fillRect(x, h-pad-bh, bw, bh); });
}

/* ===== util modal ===== */
function ensureModalClosed(){
  hide('osModalWrap');
  document.body.classList.remove('lock');
  $('#bottomBar')?.classList.remove('ui-hide');
  $('#fab')?.classList.remove('ui-hide');
}

/* ===== MODAL O.S. ===== */
let currentOSId = null, sigDrawing=false, sigLast=null;

function openOSModal(id){
  // abre somente se id válido
  if(!id){ ensureModalClosed(); return; }
  const os = get('nevar_os').find(x=>x.id===id);
  if(!os){ ensureModalClosed(); return; }

  currentOSId = id;
  $('#osModalTitle').textContent = `O.S. ${os.id}`;
  $('#osModalBody').innerHTML = `
    <div class="grid gap-3">
      <div class="grid grid-cols-2 gap-2">
        <div>
          <div class="text-mute text-xs mb-1">Cliente</div>
          <input id="osCli" class="soft w-full px-3 py-3" value="${os.cliente}">
        </div>
        <div>
          <div class="text-mute text-xs mb-1">Serviço</div>
          <input id="osSrv" class="soft w-full px-3 py-3" value="${os.servico}">
        </div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <div class="text-mute text-xs mb-1">Status</div>
          <select id="osSta" class="soft w-full px-3 py-3">
            ${['aberta','andamento','concluida'].map(s=>`<option ${os.status===s?'selected':''} value="${s}">${s}</option>`).join('')}
          </select>
        </div>
        <div>
          <div class="text-mute text-xs mb-1">Valor</div>
          <input id="osVal" type="number" class="soft w-full px-3 py-3" value="${os.valor}">
        </div>
      </div>
      <div>
        <div class="text-mute text-xs mb-1">Observações</div>
        <textarea id="osObs" class="soft w-full px-3 py-3" rows="3" placeholder="Detalhes da visita, peça trocada, etc.">${os.obs||''}</textarea>
      </div>

      <div class="grid gap-2">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Fotos</div>
          <label class="btn btn-ghost cursor-pointer">
            Adicionar <input id="osFotoUp" type="file" accept="image/*" class="hidden" multiple>
          </label>
        </div>
        <div id="osFotos" class="grid grid-cols-4 gap-2">
          ${(os.fotos||[]).map((src,i)=>`<div class="relative">
              <img src="${src}" class="w-full h-20 object-cover rounded-md border border-white/10">
              <button data-i="${i}" class="delImg absolute -top-2 -right-2 bg-danger text-white w-6 h-6 rounded-full">×</button>
            </div>`).join('')}
        </div>
      </div>

      <div>
        <div class="flex items-center justify-between">
          <div class="font-semibold">Assinatura do Cliente</div>
          <button id="sigClear" class="btn btn-ghost">Limpar</button>
        </div>
        <canvas id="sig" class="sig-pad w-full h-40"></canvas>
        ${os.ass? `<img id="sigPrev" src="${os.ass}" class="mt-2 max-h-24 rounded-md border border-white/10">` : `<img id="sigPrev" class="mt-2 hidden">`}
      </div>
    </div>
  `;

  // esconder UI e travar scroll
  document.body.classList.add('lock');
  $('#bottomBar')?.classList.add('ui-hide');
  $('#fab')?.classList.add('ui-hide');

  show('osModalWrap');

  // fechar tocando fora do conteúdo
  $('#osModalWrap').onclick = (e)=>{
    if(e.target.id === 'osModalWrap'){ closeOSModal(); }
  };

  // upload de fotos
  $('#osFotoUp').addEventListener('change', async (e)=>{
    const files = [...e.target.files].slice(0,6);
    const urls = [];
    for(const f of files){ urls.push(await fileToDataUrl(f)); }
    const all = (os.fotos||[]).concat(urls).slice(0,12);
    os.fotos = all; saveCurrentOS(os); openOSModal(id); // re-render
  });
  $$('#osFotos .delImg').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      os.fotos.splice(+btn.dataset.i,1); saveCurrentOS(os); openOSModal(id);
    });
  });

  // assinatura
  const cvs = $('#sig'), ctx = cvs.getContext('2d');
  resizeCanvasToDisplaySize(cvs);
  if(os.ass){ const img = new Image(); img.onload=()=>ctx.drawImage(img,0,0,cvs.width,cvs.height); img.src=os.ass; }
  cvs.addEventListener('pointerdown', e=>{ sigDrawing=true; sigLast=pt(cvs,e); });
  cvs.addEventListener('pointermove', e=>{
    if(!sigDrawing) return; const p=pt(cvs,e); ctx.lineCap='round'; ctx.strokeStyle='#00c2ff'; ctx.lineWidth=2.2;
    ctx.beginPath(); ctx.moveTo(sigLast.x,sigLast.y); ctx.lineTo(p.x,p.y); ctx.stroke(); sigLast=p;
  });
  ['pointerup','pointerleave','pointercancel'].forEach(ev=>cvs.addEventListener(ev, ()=> sigDrawing=false));
  $('#sigClear').addEventListener('click', ()=>{ ctx.clearRect(0,0,cvs.width,cvs.height); $('#sigPrev').classList.add('hidden') });

  // salvar/fechar/excluir/exportar
  $('#btnSaveOS').onclick = ()=>{
    os.cliente = $('#osCli').value.trim();
    os.servico = $('#osSrv').value.trim();
    os.status  = $('#osSta').value;
    os.valor   = parseFloat($('#osVal').value || '0');
    os.obs     = $('#osObs').value.trim();
    try { os.ass = cvs.toDataURL('image/png'); $('#sigPrev').src=os.ass; $('#sigPrev').classList.remove('hidden'); } catch(e){}
    saveCurrentOS(os); closeOSModal(); refreshAll();
  };
  $('#osModalClose').onclick = closeOSModal;
  $('#btnDelOS').onclick = ()=>{ if(confirm('Excluir esta O.S.?')){ const arr=get('nevar_os').filter(x=>x.id!==id); set('nevar_os',arr); closeOSModal(); refreshAll(); } };
  $('#btnExportOS').onclick = ()=> exportOSPdf(os);
}

function closeOSModal(){ ensureModalClosed(); }

function saveCurrentOS(os){ const arr = get('nevar_os').map(x=> x.id===os.id ? os : x); set('nevar_os', arr); }

function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function pt(c,e){ const r=c.getBoundingClientRect(); return {x: e.clientX - r.left, y: e.clientY - r.top}; }
function resizeCanvasToDisplaySize(canvas){
  const {width,height} = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.round(width * ratio);
  canvas.height= Math.round(height * ratio);
  const ctx = canvas.getContext('2d'); ctx.scale(ratio, ratio);
}

/* ===== Exportar PDF (via print) ===== */
function exportOSPdf(os){
  const win = window.open('', '_blank');
  const fotos = (os.fotos||[]).slice(0,4).map(src=>`<img src="${src}" style="width:23%;height:100px;object-fit:cover;border-radius:8px;border:1px solid #ddd;margin-right:1%;">`).join('');
  const ass = os.ass? `<img src="${os.ass}" style="max-height:80px;border:1px solid #ddd;border-radius:6px">` : '<em>Sem assinatura</em>';
  win.document.write(`
  <html>
  <head><meta charset="utf-8"><title>${os.id} - Nevar</title>
  <style>body{font-family:Inter,Arial,sans-serif;padding:24px;color:#111}.k{color:#555;width:130px;display:inline-block}.b{font-weight:700}.box{border:1px solid #ddd;border-radius:12px;padding:12px;margin-top:10px}</style></head>
  <body>
    <h2>Nevar — Ordem de Serviço</h2>
    <div class="box"><span class="k">Código:</span><span class="b">${os.id}</span></div>
    <div class="box"><span class="k">Cliente:</span>${os.cliente}</div>
    <div class="box"><span class="k">Serviço:</span>${os.servico}</div>
    <div class="box"><span class="k">Status:</span>${os.status}</div>
    <div class="box"><span class="k">Valor:</span>${money(os.valor)}</div>
    <div class="box"><div class="k">Observações:</div><div>${(os.obs||'').replace(/\n/g,'<br>')}</div></div>
    <div class="box"><div style="margin-bottom:8px">Fotos:</div>${fotos || '<em>Sem fotos</em>'}</div>
    <div class="box"><div style="margin-bottom:8px">Assinatura:</div>${ass}</div>
    <script>window.print(); setTimeout(()=>window.close(), 500);<\/script>
  </body></html>`);
  win.document.close();
}

/* ===== boot ===== */
function renderAllFirst(){ selectTab('dashboard'); refreshAll(); }
if(isLogged()){
  hide('authSection'); show('app'); renderAllFirst();
  ensureModalClosed(); // garante fechado
}
</script>
</body>
</html>
